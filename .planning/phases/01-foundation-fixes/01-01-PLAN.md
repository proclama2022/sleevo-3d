---
phase: 01-foundation-fixes
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/game/storage.ts
  - src/game/rules.ts
autonomous: true
requirements:
  - FIX-01
  - FIX-02
  - FIX-03

must_haves:
  truths:
    - "isLevelUnlocked() returns true only when the previous level has >= 2 stars"
    - "isLevelUnlocked() looks up the previous level by its actual .id property, not by constructing level-${index}"
    - "SLOT_TARGETS constant no longer exists; getTargetSlot() always returns null for any vinyl ID"
    - "TypeScript build passes with no errors after both changes"
  artifacts:
    - path: "src/game/storage.ts"
      provides: "Fixed isLevelUnlocked function"
      contains: "stars >= 2"
    - path: "src/game/rules.ts"
      provides: "Stubbed getTargetSlot that returns null"
      contains: "return null"
  key_links:
    - from: "src/game/storage.ts"
      to: "src/game/types.ts"
      via: "import type { Level }"
      pattern: "import.*Level.*from.*types"
    - from: "src/game/rules.ts"
      to: "getTargetSlot"
      via: "function stub"
      pattern: "getTargetSlot.*null"
---

<objective>
Fix two structural bugs in game logic files: the level-unlock threshold (FIX-01/FIX-02 combined) and the hardcoded SLOT_TARGETS map (FIX-03).

Purpose: These are pure logic correctness fixes with no visual surface. They must land before Phase 3 connects the progression system, and before level expansion makes v1-v8 hardcoding a runtime failure.

Output: `storage.ts` with a corrected `isLevelUnlocked()` function; `rules.ts` with `SLOT_TARGETS` removed and `getTargetSlot()` stubbed to always return null.
</objective>

<execution_context>
@/Users/martha2022/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martha2022/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/game/storage.ts
@src/game/rules.ts
@src/game/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix isLevelUnlocked (FIX-01 + FIX-02)</name>
  <files>src/game/storage.ts</files>
  <action>
Replace the existing `isLevelUnlocked(levelIndex: number): boolean` function (lines 42-50) with a new signature that accepts the levels array and uses the previous level's actual `.id` property:

```typescript
import type { Level } from './types';

export function isLevelUnlocked(levelIndex: number, levels: Level[]): boolean {
  if (levelIndex === 0) return true;
  const prevLevel = levels[levelIndex - 1];
  if (!prevLevel) return false;
  const progress = getLevelProgress(prevLevel.id);
  return progress !== null && progress.stars >= 2; // FIX-01: was >= 1; FIX-02: uses .id not index arithmetic
}
```

Add `import type { Level } from './types';` at the top of the file if not already present.

Note: `isLevelUnlocked` is currently unused anywhere in the codebase — no call sites need updating. The new signature is ready for Phase 3 when the level select screen is wired.

Do NOT touch `saveProgress()` or `getLevelProgress()` — they already use `levelId` correctly.
  </action>
  <verify>Run `npx tsc --noEmit` from the project root — must report 0 errors related to storage.ts. Confirm the function body contains `stars >= 2` and `prevLevel.id`.</verify>
  <done>storage.ts compiles cleanly; isLevelUnlocked uses prevLevel.id and requires >= 2 stars.</done>
</task>

<task type="auto">
  <name>Task 2: Remove SLOT_TARGETS and stub getTargetSlot (FIX-03)</name>
  <files>src/game/rules.ts</files>
  <action>
In `src/game/rules.ts`:

1. Delete the entire `SLOT_TARGETS` constant (lines 3-12 — the `Record<string, string>` mapping v1-v8 to slot keys).

2. Replace the existing `getTargetSlot(vinylId: string)` function body with a stub that always returns null:

```typescript
export function getTargetSlot(_vinylId: string): { row: number; col: number } | null {
  return null; // FIX-03: SLOT_TARGETS removed; hint glow is disabled (no hint button in UI)
}
```

Keep all other exports intact: `getSlotKey`, `matchesCustomerRequest`, `isValidPlacement`, `COMBO_TIERS`, `COMBO_DECAY_MS`, `COLUMN_GENRES`, `ERA_MAP`.

Context: `getTargetSlot` feeds `getNextGlowingSlot()` which only activates when `state.hintsRemaining < 3`. Hints start at 3 and there is no hint button in `Controls.tsx` — so `SHOW_HINT` is never dispatched. The glow-via-hint path is unreachable at runtime. Stubbing to `null` is equivalent to the current runtime behavior.

Do NOT remove `getSlotKey` — it is used elsewhere for slot key generation.
  </action>
  <verify>Run `npx tsc --noEmit` — 0 errors. Confirm `SLOT_TARGETS` no longer appears in rules.ts. Confirm `getTargetSlot` returns null. Run `npm run build` to confirm no bundler errors.</verify>
  <done>rules.ts compiles cleanly; SLOT_TARGETS is gone; getTargetSlot always returns null; build succeeds.</done>
</task>

</tasks>

<verification>
After both tasks:
1. `npx tsc --noEmit` passes with 0 errors
2. `npm run build` produces a clean dist/ output
3. Grep for `SLOT_TARGETS` in the codebase returns no results (or only comments)
4. `storage.ts` contains `stars >= 2` (not `>= 1`)
5. `storage.ts` contains `prevLevel.id` (not `level-${levelIndex}`)
</verification>

<success_criteria>
- FIX-01: isLevelUnlocked requires >= 2 stars to return true
- FIX-02: isLevelUnlocked uses the previous level's .id property from the passed levels array
- FIX-03: SLOT_TARGETS removed; getTargetSlot() always returns null
- TypeScript build clean with no errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-fixes/01-01-SUMMARY.md`
</output>
