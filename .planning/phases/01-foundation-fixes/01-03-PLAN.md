---
phase: 01-foundation-fixes
plan: "03"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ScorePopup/ScorePopup.tsx
  - src/components/HUD/HUD.tsx
  - src/components/GameScreen.tsx
autonomous: false
requirements:
  - COMM-01
  - COMM-02
  - COMM-03

must_haves:
  truths:
    - "A floating '+N' label (or '+N GREAT!' when combo fires) appears near the HUD score area within 200ms of every correct vinyl placement"
    - "The HUD shows '5 / 8' format counter that updates with each successful drop (COMM-02 format: numbers only, no text)"
    - "The HUD shows an icon + short label badge for the active level rule for the entire level duration"
    - "Free mode shows no rule badge (hidden)"
    - "Score popup appears near the HUD score (top-left area) ‚Äî NOT near the dropped shelf slot"
  artifacts:
    - path: "src/components/ScorePopup/ScorePopup.tsx"
      provides: "ScorePopup with optional label prop"
      contains: "label?"
    - path: "src/components/HUD/HUD.tsx"
      provides: "HUD with placed/total counter and sortRule/levelMode badge"
      contains: "placed"
    - path: "src/components/GameScreen.tsx"
      provides: "ScorePopup wiring and HUD prop passing"
      contains: "scorePopups"
  key_links:
    - from: "src/components/GameScreen.tsx"
      to: "src/components/ScorePopup/ScorePopup.tsx"
      via: "scorePopups state array rendered in JSX"
      pattern: "scorePopups\\.map"
    - from: "src/components/GameScreen.tsx"
      to: "src/components/HUD/HUD.tsx"
      via: "placed and total props"
      pattern: "placed=\\{.*\\}.*total=\\{.*\\}"
    - from: "src/components/GameScreen.tsx"
      to: "handlePointerUp"
      via: "setScorePopups called before dispatch on valid PLACE_VINYL"
      pattern: "setScorePopups"
---

<objective>
Wire the three player communication elements: floating score feedback popup (COMM-01), HUD vinyl counter (COMM-02), and HUD level rule badge (COMM-03).

Purpose: These are the feedback loops that make the game legible ‚Äî players need to see what they earned, how far they've progressed, and what rule they're following. All three components are already partially built; this plan connects them.

Output: ScorePopup wired to PLACE_VINYL dispatch; HUD showing "5 / 8" counter; HUD showing icon+label rule badge.
</objective>

<execution_context>
@/Users/martha2022/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martha2022/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/ScorePopup/ScorePopup.tsx
@src/components/HUD/HUD.tsx
@src/components/GameScreen.tsx
@src/game/rules.ts
@src/game/types.ts
@src/animations/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ScorePopup with label prop (COMM-01 prerequisite)</name>
  <files>src/components/ScorePopup/ScorePopup.tsx</files>
  <action>
Read `src/components/ScorePopup/ScorePopup.tsx` fully before editing.

Add `label?: string` to the `ScorePopupProps` interface (or type, whatever the component uses).

In the render body, after `{points}`, render the label conditionally:
```tsx
{label && <span style={{ marginLeft: 4, fontSize: '0.8em', opacity: 0.9 }}>{label}</span>}
```

The existing animation (`animations.scoreFloat` or similar), positioning (`position: fixed`, `$x`, `$y` props), and `onComplete` callback must remain unchanged.

Do NOT add animation to the label span ‚Äî keep it static within the parent animation.

The final rendered text should be: `+10` (no combo) or `+35 GREAT!` (with combo label).
  </action>
  <verify>Run `npx tsc --noEmit` ‚Äî 0 errors. The ScorePopup component accepts `label?: string` prop.</verify>
  <done>ScorePopup compiles with label prop; renders "+N" or "+N LABEL" depending on whether label is provided.</done>
</task>

<task type="auto">
  <name>Task 2: Extend HUD with placed/total counter and rule badge (COMM-02 + COMM-03)</name>
  <files>src/components/HUD/HUD.tsx</files>
  <action>
Read `src/components/HUD/HUD.tsx` fully before editing.

**COMM-02 ‚Äî Add placed/total counter:**

Extend `HUDProps` (or the existing interface) with:
```typescript
placed: number;
total: number;
```

Add a `StatItem` (or equivalent styled block using the existing HUD pattern) in the `RightSection` that renders `{placed} / {total}`. No animation. Use whatever styled component pattern already exists for stat display (e.g., if `moves` is shown as a `StatItem`, follow the same pattern).

**COMM-03 ‚Äî Add level rule badge:**

Extend `HUDProps` with:
```typescript
sortRule?: string;
levelMode?: string;
```

Add a `getLevelRuleDisplay` helper function (can be inside the file or at the top):
```typescript
function getLevelRuleDisplay(
  sortRule: string,
  mode: string
): { icon: string; label: string } | null {
  if (mode === 'customer')          return { icon: 'üë§', label: 'Cliente' };
  if (mode === 'blackout')          return { icon: 'üëÅ', label: 'Memoria' };
  if (mode === 'rush')              return { icon: '‚è±', label: 'Rush' };
  if (mode === 'sleeve-match')      return { icon: 'üñº', label: 'Abbina' };
  if (sortRule === 'genre')         return { icon: 'üéµ', label: 'Genere' };
  if (sortRule === 'chronological') return { icon: 'üìÖ', label: 'Anno' };
  return null; // free mode ‚Äî no badge shown
}
```

Render the result as a small pill/badge in the HUD. The rule never changes mid-level so no animation needed. Use styled-components following the existing HUD pattern. The badge should be visually distinct but not dominant ‚Äî subordinate to the score.

Position decision (Claude's discretion): Place it in `CenterSection` below the circular progress gauge, or at the bottom of `LeftSection`. Choose whichever integrates most naturally with the existing grid layout after reading the component.
  </action>
  <verify>Run `npx tsc --noEmit` ‚Äî 0 errors. HUD accepts `placed`, `total`, `sortRule`, `levelMode` props.</verify>
  <done>HUD compiles with all new props; renders "5 / 8" counter and rule badge (or nothing for free mode).</done>
</task>

<task type="auto">
  <name>Task 3: Wire ScorePopup and new HUD props in GameScreen (COMM-01 + COMM-02 + COMM-03)</name>
  <files>src/components/GameScreen.tsx</files>
  <action>
Read `src/components/GameScreen.tsx` fully before editing. Pay attention to: `handlePointerUp`, the `dispatch` call for `PLACE_VINYL`, the existing `ComboPopup` pattern (reference for popup management), and the HUD render call.

**ScorePopup wiring (COMM-01):**

Add popup state and ref near the top of GameScreen:
```typescript
const [scorePopups, setScorePopups] = useState<Array<{
  id: number;
  points: number;
  label: string;
  x: number;
  y: number;
}>>([]);
const popupIdRef = useRef(0);
```

Add a ref for the HUD score element to get its position:
```typescript
const scoreElementRef = useRef<HTMLElement | null>(null);
```

Pass this ref down to HUD via a new optional `scoreRef` prop, or alternatively hardcode fallback coordinates `{ x: 56, y: 52 }` if threading the ref is complex. Fallback coordinates are acceptable per research.

In `handlePointerUp`, find the point where a valid drop is confirmed (where `PLACE_VINYL` is dispatched). BEFORE dispatching, calculate the earned points to show in the popup:

```typescript
// COMBO_TIERS and COMBO_DECAY_MS must be imported from '../game/rules' ‚Äî add imports if not present

// In handlePointerUp, before dispatch:
const timeSinceLast = Date.now() - state.combo.lastPlacementTime;
const comboReset = state.combo.lastPlacementTime > 0 && timeSinceLast > COMBO_DECAY_MS;
const newStreak = comboReset ? 1 : state.combo.streak + 1;
const tier = [...COMBO_TIERS].reverse().find(t => newStreak >= t.minStreak) ?? COMBO_TIERS[0];
const earned = Math.round(100 * tier.multiplier);
const popupX = scoreElementRef.current?.getBoundingClientRect().x ?? 56;
const popupY = scoreElementRef.current?.getBoundingClientRect().y ?? 52;
setScorePopups(prev => [...prev, {
  id: popupIdRef.current++,
  points: earned,
  label: tier.label,
  x: popupX,
  y: popupY,
}]);
```

Important: `COMBO_TIERS` is a `const` array ‚Äî spread it before reversing (`[...COMBO_TIERS].reverse()`). Do NOT call `.reverse()` on the original const array.

In the JSX, render the popups alongside the existing `ComboPopup` render:
```tsx
{scorePopups.map(p => (
  <ScorePopup
    key={p.id}
    points={p.points}
    label={p.label}
    x={p.x}
    y={p.y}
    onComplete={() => setScorePopups(prev => prev.filter(sp => sp.id !== p.id))}
  />
))}
```

**HUD props (COMM-02 + COMM-03):**

Find the existing `<HUD ... />` render call in GameScreen. Add the new props:
```tsx
placed={Object.keys(state.placedVinyls).length}
total={state.level.vinyls.length}
sortRule={state.level.sortRule}
levelMode={state.level.mode}
```

Verify that `state.level.sortRule` and `state.level.mode` exist on the Level type in `src/game/types.ts`. If the field is named differently (e.g., `sortBy`, `gameMode`), use the correct field name from the type definition.

Do NOT use `lastSlotPosition` for ScorePopup ‚Äî that's for `ComboPopup`. ScorePopup must use the HUD score coordinates, not slot coordinates. This is a locked decision.
  </action>
  <verify>
1. `npx tsc --noEmit` ‚Äî 0 errors
2. `npm run dev` ‚Äî game loads without console errors
3. Drop a vinyl on the correct slot ‚Äî score popup appears near top-left HUD score area (not near the slot)
4. HUD shows "N / M" counter that increments on correct drops
5. HUD shows rule badge (e.g., "üéµ Genere") for genre levels; nothing for free mode
  </verify>
  <done>GameScreen compiles; ScorePopup fires on each correct drop near HUD score; HUD counter and rule badge display correctly.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Verify all three communication elements in-browser</name>
  <action>
Run `npm run dev` from the project root to start the dev server, then follow the verification steps below in the browser.
  </action>
  <verify>
1. Open http://localhost:5173 in the browser
2. Drop a vinyl onto a correct shelf slot
   - Expected: a floating "+N" (or "+N GREAT!" after 4+ streak) appears near the score in the top-left HUD area
   - Expected: the "N / M" counter in the HUD increments (e.g., "1 / 8" after first correct drop)
3. Check the HUD for the rule badge
   - Expected: an icon + label (e.g., "üéµ Genere") visible throughout the level
   - If the current level is free mode, no badge should appear
4. Drop 4+ vinyls in quick succession (within 4 seconds of each other)
   - Expected: popup label escalates to "NICE!" then "GREAT!" etc.
5. Confirm popup appears near the score number (top-left), NOT near the shelf slot where the vinyl was dropped
  </verify>
  <done>User confirms all 5 checks pass: popup fires near HUD score, counter increments, rule badge shows, combo labels escalate correctly.</done>
  <what-built>
    - ScorePopup extended with label prop and wired to PLACE_VINYL dispatch
    - HUD "N / M" counter added
    - HUD level rule badge added
  </what-built>
  <resume-signal>Type "approved" if all 5 checks pass, or describe any issues seen</resume-signal>
</task>

</tasks>

<verification>
After checkpoint approval:
1. ScorePopup fires on every correct vinyl placement ‚Äî never on incorrect drops
2. Popup appears near HUD score (top-left), not near shelf slot
3. Combo label ("NICE!", "GREAT!", etc.) appears in popup when streak threshold is hit
4. HUD counter format is "N / M" with no extra text
5. HUD rule badge shows icon + mode/rule label for non-free levels
6. Free mode: no rule badge shown
7. `npx tsc --noEmit` ‚Äî 0 errors
</verification>

<success_criteria>
- COMM-01: Floating "+N" or "+N LABEL" appears near HUD score within 200ms of each correct drop
- COMM-02: HUD displays "placed / total" counter in "5 / 8" format, updating live
- COMM-03: HUD displays persistent icon + label badge for the active level rule; hidden for free mode
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-fixes/01-03-SUMMARY.md`
</output>
