---
phase: 04-level-content-and-mode-validation
plan: "03"
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified:
  - src/game/engine.ts
autonomous: true
requirements:
  - MODE-02

must_haves:
  truths:
    - "The blackout label-hide transition is driven by a pure reducer case (BLACKOUT_TICK), not a useEffect setTimeout"
    - "createGameState initializes blackoutSecondsLeft from the level mode"
    - "BLACKOUT_TICK decrements blackoutSecondsLeft and sets labelsVisible = false when it reaches zero"
    - "engine.ts compiles clean — no reference to the old timeLimit field remains"
  artifacts:
    - path: "src/game/engine.ts"
      provides: "BLACKOUT_TICK action, blackoutSecondsLeft in createGameState, RUSH_TICK uses rushTime"
      contains: "BLACKOUT_TICK"
  key_links:
    - from: "src/game/engine.ts"
      to: "src/game/types.ts"
      via: "blackoutSecondsLeft in GameState, rushTime in Level"
      pattern: "blackoutSecondsLeft|rushTime"
---

<objective>
Fix the blackout mode engine: move the label-hide logic out of a React useEffect timeout and into a pure reducer action (BLACKOUT_TICK). Also rename all engine.ts references from `timeLimit` to `rushTime` to match the updated Level type from Plan 01.

Purpose: The RESEARCH identified the blackout flicker bug — a useEffect that can fire duplicate timers. Moving hide logic to the reducer makes it deterministic and testable. This is the engine-only change; the useEffect interval driver in GameScreen is updated in Plan 05.

Output: Updated src/game/engine.ts only.
</objective>

<execution_context>
@/Users/martha2022/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martha2022/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-level-content-and-mode-validation/04-CONTEXT.md
@.planning/phases/04-level-content-and-mode-validation/04-RESEARCH.md
@src/game/engine.ts
@src/game/types.ts
@.planning/phases/04-level-content-and-mode-validation/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add BLACKOUT_TICK to engine and rename timeLimit to rushTime</name>
  <files>src/game/engine.ts</files>
  <action>
Make the following targeted changes to src/game/engine.ts:

**Step 1 — Rename timeLimit to rushTime in createGameState:**
Find the line that reads something like `rushTimeLeft: level.timeLimit ?? 0,` and change `level.timeLimit` to `level.rushTime`.

**Step 2 — Add blackoutSecondsLeft to createGameState:**
In the createGameState return object, find the block where `labelsVisible` is initialized. After or near that line, add:
```typescript
blackoutSecondsLeft: level.mode === 'blackout' ? 3 : 0,
```

**Step 3 — Add BLACKOUT_TICK to the GameAction union type:**
Find the `GameAction` type union (the type with `| { type: 'RESTART' }` etc.) and add:
```typescript
| { type: 'BLACKOUT_TICK' }
```

**Step 4 — Add BLACKOUT_TICK reducer case:**
In the switch statement of gameReducer, add a new case after the existing BLACKOUT_TRIGGER case (or wherever is logical):
```typescript
case 'BLACKOUT_TICK': {
  if (state.status !== 'playing' || state.blackoutSecondsLeft <= 0) return state;
  const newCount = state.blackoutSecondsLeft - 1;
  return {
    ...state,
    blackoutSecondsLeft: newCount,
    labelsVisible: newCount > 0,
  };
}
```
This is pure engine logic: the `labelsVisible` transition now happens inside the reducer, not in a setTimeout. The BLACKOUT_TRIGGER action (if it still exists) can remain for backward compatibility or be removed — but do NOT remove it yet as GameScreen.tsx still references it (that cleanup happens in Plan 05).

**Step 5 — Ensure RESTART and NEXT_LEVEL reset blackoutSecondsLeft:**
Find the RESTART case reducer — it should call createGameState(). Since createGameState now initializes blackoutSecondsLeft, this is automatic. Verify the NEXT_LEVEL case also calls createGameState(). No additional changes needed if they already delegate to createGameState.
  </action>
  <verify>
    <automated>cd /Users/martha2022/Documents/Sleevo && npx tsc --noEmit 2>&1 | head -20</automated>
    <manual>Confirm engine.ts has blackoutSecondsLeft in createGameState return, BLACKOUT_TICK in GameAction, and BLACKOUT_TICK case in the reducer; no remaining timeLimit references</manual>
    <sampling_rate>run after changes — must be zero errors in engine.ts before Plan 05</sampling_rate>
  </verify>
  <done>TypeScript compiles with zero errors in engine.ts. BLACKOUT_TICK action exists in the union type and has a reducer case. createGameState initializes blackoutSecondsLeft to 3 for blackout levels and 0 otherwise. rushTime is used (not timeLimit) for rushTimeLeft initialization.</done>
</task>

</tasks>

<verification>
Run: `cd /Users/martha2022/Documents/Sleevo && npx tsc --noEmit 2>&1 | head -20`
Expected: zero errors (or only errors in GameScreen.tsx for BLACKOUT_TRIGGER which is cleaned in Plan 05).

Run: `grep -n "BLACKOUT_TICK" /Users/martha2022/Documents/Sleevo/src/game/engine.ts`
Expected: at least 2 lines (union type entry + reducer case).

Run: `grep -n "timeLimit" /Users/martha2022/Documents/Sleevo/src/game/engine.ts`
Expected: no output.

Run: `grep -n "blackoutSecondsLeft" /Users/martha2022/Documents/Sleevo/src/game/engine.ts`
Expected: at least 2 lines (createGameState + BLACKOUT_TICK case).
</verification>

<success_criteria>
- engine.ts has BLACKOUT_TICK in GameAction union and in reducer
- createGameState sets blackoutSecondsLeft = 3 for blackout mode, 0 otherwise
- No timeLimit references remain in engine.ts
- TypeScript zero errors in engine.ts
</success_criteria>

<output>
After completion, create `.planning/phases/04-level-content-and-mode-validation/04-03-SUMMARY.md`
</output>
