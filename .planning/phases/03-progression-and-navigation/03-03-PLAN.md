---
phase: 03-progression-and-navigation
plan: "03"
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - src/components/LevelComplete.tsx
autonomous: false
requirements:
  - PROG-01
  - PROG-02
  - PROG-03

must_haves:
  truths:
    - "LevelComplete button reads 'Continua â†’' (not 'Livello successivo â†’') since it now returns to map"
    - "Best star count is preserved â€” a worse replay never overwrites a better result"
    - "After a level is completed with >= 2 stars, the next level appears unlocked on return to level select"
    - "saveProgress is called with the final stars and time so progress persists across sessions"
  artifacts:
    - path: "src/components/LevelComplete.tsx"
      provides: "Updated Continue button label; saveProgress called with best-only semantics"
      contains: "Continua"
  key_links:
    - from: "src/components/LevelComplete.tsx"
      to: "src/game/storage.ts"
      via: "saveProgress already called in GameScreen on level complete; LevelComplete button calls onNextLevel which routes to onReturnToSelect in App.tsx"
      pattern: "onNextLevel"
---

<objective>
Update LevelComplete so its Continue button label matches the new flow (returns to level select, not auto-advance) and verify that the saveProgress call uses best-only semantics.

Purpose: After Plan 02 wires `onNextLevel={onReturnToSelect}` in GameScreen, the button label "Livello successivo â†’" is misleading â€” it no longer advances to the next level. This plan fixes the label and validates the persistence flow, then checks the full end-to-end with a human-verify checkpoint.
Output: Modified LevelComplete.tsx with updated button text; confirmed saveProgress best-only wiring; human sign-off on the complete Phase 3 flow.
</objective>

<execution_context>
@/Users/martha2022/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martha2022/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-progression-and-navigation/03-CONTEXT.md
@.planning/phases/03-progression-and-navigation/03-RESEARCH.md

@src/components/LevelComplete.tsx
@src/components/GameScreen.tsx
@src/game/storage.ts
@.planning/phases/03-progression-and-navigation/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update LevelComplete button label and validate persistence</name>
  <files>src/components/LevelComplete.tsx</files>
  <action>
Make two targeted changes to src/components/LevelComplete.tsx:

**Change 1 â€” Button label and hasNextLevel guard:**
The existing code conditionally renders either a button or a "completed" message based on `hasNextLevel`. After Phase 3, "Continue" always returns to level select regardless of whether there is a next level. Replace the entire guard block:

Before:
```tsx
{hasNextLevel ? (
  <button className={styles.btnPrimary} onClick={onNextLevel}>
    Livello successivo â†’
  </button>
) : (
  <div className={styles.noNextLevel}>Hai completato tutti i livelli! ðŸŽ‰</div>
)}
```

After:
```tsx
<button className={styles.btnPrimary} onClick={onNextLevel}>
  {hasNextLevel ? 'Continua â†’' : 'Torna alla mappa â†’'}
</button>
```

The button always renders. `hasNextLevel` now only changes the label text (not visibility). Keep `hasNextLevel` in the Props interface â€” do not remove it.

**Change 2 â€” Persistence verification (may require storage.ts update):**
Read src/game/storage.ts and verify `saveProgress` implements best-only semantics (only writes if new stars > existing stored stars). If best-only logic is already present, no change needed.

If best-only logic is MISSING (saveProgress overwrites unconditionally), update saveProgress in src/game/storage.ts to:
```typescript
export function saveProgress(levelId: string, stars: number, bestTime?: number): void {
  try {
    const existing = getLevelProgress(levelId);
    // Only update if new result is better â€” never overwrite a better result
    if (existing && existing.stars >= stars) return;
    const all = loadAllProgress();
    all[levelId] = { stars, bestTime };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(all));
  } catch {
    // localStorage unavailable â€” fail silently
  }
}
```

Add src/game/storage.ts to files_modified only if a code change is needed there.
  </action>
  <verify>
    <automated>cd /Users/martha2022/Documents/Sleevo && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>LevelComplete.tsx button text updated to "Continua â†’" / "Torna alla mappa â†’"; TypeScript compiles clean</manual>
  </verify>
  <done>LevelComplete.tsx compiles without TypeScript errors; Continue button always renders with text "Continua â†’" (or "Torna alla mappa â†’" on last level); hasNextLevel prop retained in interface; saveProgress uses best-only semantics</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Full Phase 3 end-to-end verification</name>
  <action>Run `npm run dev` from project root and test the complete progression flow in browser as described in how-to-verify.</action>
  <verify>
    <automated>cd /Users/martha2022/Documents/Sleevo && npm run build 2>&1 | tail -10</automated>
    <manual>Follow the 10-step verification checklist in how-to-verify below</manual>
  </verify>
  <done>All 10 verification steps pass; user types "approved"</done>
  <what-built>
Complete Phase 3 progression flow:
- Plan 01: LevelSelect component with 3-column grid, locked/unlocked state, scrollIntoView on focused cell
- Plan 02: App.tsx screen router (levelSelect playing), GameScreen initialLevelIndex prop
- Plan 03: LevelComplete "Continua" button returns to level select
  </what-built>
  <how-to-verify>
1. Run `npm run dev` and open the app in browser
2. App should open at the level select screen ("Scegli Livello") â€” NOT directly at gameplay
3. Only Level 1 should be unlocked (no dimming, no padlock). Levels 2+ should be dimmed with lock icon
4. Tap Level 1 â€” gameplay should start at Level 1
5. Complete Level 1 (place all vinyls) â€” LevelComplete overlay should appear with "Continua" button
6. Tap "Continua" â€” should return to level select screen
7. If you earned >= 2 stars on Level 1, Level 2 should now appear unlocked on the level select
8. Open browser DevTools â†’ Application â†’ localStorage â†’ verify `sleevo_progress` key exists with JSON showing Level 1 stars
9. Reload the page â€” app should open at level select, with the first incomplete level highlighted (scrolled into view if needed)
10. Replay Level 1 and complete it with fewer stars â€” the displayed star count on Level 1 cell should NOT decrease
  </how-to-verify>
  <resume-signal>Type "approved" if all steps pass, or describe which step failed and what you observed</resume-signal>
</task>

</tasks>

<verification>
Run `npx tsc --noEmit` â€” must report 0 errors.
Manual end-to-end: App opens at level select â†’ play level 1 â†’ LevelComplete shows "Continua â†’" â†’ returns to level select â†’ Level 2 unlocked if >= 2 stars â†’ reload preserves progress.
Check localStorage: `localStorage.getItem('sleevo_progress')` in DevTools console returns JSON with at least `{'level-1': { stars: N }}`.
</verification>

<success_criteria>
- TypeScript compiles clean (0 errors) across all three modified/created files
- App opens at level select, not gameplay
- Level select shows correct locked/unlocked states from localStorage
- Playing a level and returning updates the level select with newly earned stars
- Best stars are preserved: replaying a level and doing worse does not reduce the displayed star count
- "Continua â†’" button on LevelComplete returns to level select (not auto-advance)
- Progress persists across browser reload
</success_criteria>

<output>
After completion, create `.planning/phases/03-progression-and-navigation/03-03-SUMMARY.md`
</output>
