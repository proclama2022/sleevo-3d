---
phase: 02-core-ui-components
plan: "02-06"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ShelfSlot.tsx
autonomous: true
gap_closure: true
requirements:
  - COMP-02

must_haves:
  truths:
    - "User sees recessed inset shadow when a vinyl is placed in a slot"
    - "User sees gold sparkle points (✦) briefly after a correct vinyl placement"
    - "User sees pulsing glow ring (green valid, red invalid) animated by styled-components keyframe, not just CSS data-attribute"
  artifacts:
    - path: "src/components/ShelfSlot.tsx"
      provides: "Single ShelfSlot implementation with recessed filled state and sparkle effect"
      contains: "SparkleEffect"
  key_links:
    - from: "src/components/Shelf.tsx"
      to: "src/components/ShelfSlot.tsx"
      via: "import { ShelfSlot } from './ShelfSlot'"
      pattern: "import.*ShelfSlot.*from.*./ShelfSlot"
---

<objective>
Merge the recessed filled-state and sparkle effect from the orphaned `ShelfSlot/ShelfSlot.tsx` into the flat `src/components/ShelfSlot.tsx` that Shelf.tsx actually imports and renders.

Purpose: The new ShelfSlot folder component (with recessed box-shadow and SparkleEffect) is silently bypassed because Vite module resolution gives priority to the flat `.tsx` file over a directory `index.ts`. The flat file has no recessed state and no sparkle — so users never see these locked visual features.

Output: A single `src/components/ShelfSlot.tsx` that is the definitive implementation, combining the existing interface + interaction logic with the recessed filled state and sparkle effect from the folder version.
</objective>

<execution_context>
@/Users/martha2022/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martha2022/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-ui-components/02-VERIFICATION.md
@src/components/ShelfSlot.tsx
@src/components/ShelfSlot/ShelfSlot.tsx
@src/components/Shelf.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Merge recessed state and sparkle into flat ShelfSlot.tsx</name>
  <files>src/components/ShelfSlot.tsx</files>
  <action>
    The flat `src/components/ShelfSlot.tsx` is the file Shelf.tsx actually uses (Vite resolves `./ShelfSlot` to this file before the folder index). It must gain the visual features from `src/components/ShelfSlot/ShelfSlot.tsx`.

    Keep the EXISTING interface and all existing props unchanged (ShelfSlotProps with row, col, vinyl, isGlowing, rejected, glowing, labelsVisible, blocked, sleeveHint, onRegister, onUnregister, onDragStart). Do NOT adopt the new component's different props interface (id/state/onDrop etc) — those are incompatible with Shelf.tsx.

    Add these features from the folder ShelfSlot:

    1. **Sparkle effect** — Add three imports at the top from styled-components:
       - `keyframes` from 'styled-components'
       - Add `useState, useRef` to existing React imports (already has `useEffect, useRef`)

    2. **SparklePoint styled component** — Add after existing styles block:
       ```
       const sparkleAnim = keyframes`
         0% { transform: scale(0) rotate(0deg); opacity: 1; }
         50% { transform: scale(1.2) rotate(180deg); opacity: 1; }
         100% { transform: scale(0) rotate(360deg); opacity: 0; }
       `;
       const SparklePoint = styled.span<{ $delay: number }>`
         position: absolute;
         font-size: 12px;
         color: #ffd700;
         text-shadow: 0 0 4px rgba(255, 215, 0, 0.8);
         animation: ${sparkleAnim} 0.6s ease-out forwards;
         animation-delay: ${(props) => props.$delay}ms;
         opacity: 0;
         pointer-events: none;
       `;
       ```
       Note: Use styled-components for SparklePoint. Import `styled` from 'styled-components'.

    3. **Sparkle trigger state** — Inside the `ShelfSlot` function component, add:
       ```
       const [showSparkle, setShowSparkle] = useState(false);
       const prevVinylIdSparkle = useRef<string | undefined>(undefined);
       ```
       Add a useEffect after the existing ones that triggers when `vinyl` transitions from undefined/null to a new id:
       ```
       useEffect(() => {
         if (vinyl && vinyl.id !== prevVinylIdSparkle.current) {
           setShowSparkle(true);
           const timer = setTimeout(() => setShowSparkle(false), 900);
           prevVinylIdSparkle.current = vinyl.id;
           return () => clearTimeout(timer);
         }
         if (!vinyl) {
           prevVinylIdSparkle.current = undefined;
         }
       }, [vinyl]);
       ```

    4. **Recessed filled state** — In the existing JSX, when `vinyl` is truthy, add inline styles to the outer `<div ref={ref} className={cls}>` to apply the recessed inset shadow:
       Add a `style` prop computed as:
       ```
       style={vinyl ? {
         boxShadow: 'inset 0 4px 12px rgba(0,0,0,0.55), inset 0 2px 4px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.04)',
       } : undefined}
       ```

    5. **Sparkle render** — At the end of the outer `<div>` children (after existing content), add:
       ```
       {showSparkle && (
         <div style={{ position: 'absolute', inset: 0, pointerEvents: 'none', zIndex: 10 }} aria-hidden="true">
           {[
             { top: '8%', left: '12%', delay: 0 },
             { top: '15%', right: '15%', delay: 100 },
             { top: '40%', left: '5%', delay: 200 },
             { top: '50%', right: '8%', delay: 150 },
             { top: '75%', left: '10%', delay: 250 },
             { top: '85%', right: '12%', delay: 50 },
           ].map((pt, i) => (
             <SparklePoint key={i} $delay={pt.delay} style={{ top: pt.top, left: pt.left, right: (pt as any).right }}>
               ✦
             </SparklePoint>
           ))}
         </div>
       )}
       ```

    Important constraints:
    - Do NOT import from styled-components' ThemeProvider context — the flat ShelfSlot uses CSS modules (`styles` from `./ShelfSlot.module.css`), not styled-components. Use only `styled` and `keyframes` from 'styled-components' for the new styled components (SparklePoint). The existing component structure stays as CSS modules.
    - The `useState` import: the file currently does not import useState. Add it to the React import: `import { useEffect, useRef, useState, type CSSProperties } from 'react';`
    - SparklePoint does NOT use `props.theme` — hardcode the gold color `#ffd700` directly (no theme dependency).
    - Do NOT remove or modify ShelfSlot.module.css.
    - Do NOT change the exported interface ShelfSlotProps.
    - The existing audio feedback useEffect (vinyl_slide.mp3 playback) already in the flat file must remain unchanged.
  </action>
  <verify>
    Run `npx tsc --noEmit` from project root — must produce zero new errors related to ShelfSlot.tsx.
    Run `npm run build` — build must succeed without error.
    Check that `src/components/Shelf.tsx` line 2 still reads `import { ShelfSlot } from './ShelfSlot'` and resolves to the flat file (no import path change needed).
  </verify>
  <done>
    `src/components/ShelfSlot.tsx` contains SparklePoint styled component and sparkle trigger logic.
    When a vinyl is placed in a slot, the outer div gains inset box-shadow (recessed look).
    When vinyl transitions from absent to present, sparkle points render for ~900ms.
    TypeScript compiles without new errors. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero TypeScript errors in ShelfSlot.tsx
2. `npm run build` — Vite build succeeds
3. Grep confirms ShelfSlot.tsx now contains `SparklePoint` and `sparkleAnim`: `grep -n "SparklePoint\|sparkleAnim\|showSparkle" src/components/ShelfSlot.tsx`
4. Grep confirms no import of ShelfSlot changed in Shelf.tsx: `grep "ShelfSlot" src/components/Shelf.tsx`
</verification>

<success_criteria>
- `src/components/ShelfSlot.tsx` is the single definitive ShelfSlot used by the app
- Recessed inset box-shadow appears when vinyl is present in a slot
- Sparkle (6 gold ✦ points with staggered delays) renders on new vinyl placement
- No TypeScript errors, build succeeds
- Shelf.tsx import unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-ui-components/02-06-SUMMARY.md`
</output>
