---
phase: 06-level-complete-record-badge
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/GameScreen.tsx
  - src/components/LevelComplete.tsx
  - src/components/LevelComplete.module.css
autonomous: false
requirements: [COMPLETE-01, COMPLETE-02]

must_haves:
  truths:
    - "After beating a previous best, the level-complete card shows the 'Nuovo Record!' badge"
    - "The badge shows the improvement delta formatted as '+340 pt' using the it-IT locale"
    - "Completing a level for the first time shows NO badge (no prior record to beat)"
    - "Replaying a level and scoring lower shows NO badge"
    - "The badge does not persist into a subsequent run (reset on handleRestart and handleNext)"
  artifacts:
    - path: "src/components/GameScreen.tsx"
      provides: "isNewRecord and scoreDelta useState; computed in completion useEffect before saveProgress; passed as props to LevelComplete; reset in handleRestart and handleNext"
      exports: []
    - path: "src/components/LevelComplete.tsx"
      provides: "isNewRecord? and scoreDelta? props accepted; badge conditionally rendered using formatScore for delta"
      contains: "isNewRecord"
    - path: "src/components/LevelComplete.module.css"
      provides: "recordBadge, recordBadgeTitle, recordBadgeDelta classes and recordPulse keyframe"
      contains: "recordPulse"
  key_links:
    - from: "src/components/GameScreen.tsx completion useEffect"
      to: "getLevelProgress(state.level.id)"
      via: "synchronous read BEFORE saveProgress call"
      pattern: "getLevelProgress.*before.*saveProgress"
    - from: "src/components/GameScreen.tsx JSX"
      to: "src/components/LevelComplete.tsx"
      via: "isNewRecord and scoreDelta props"
      pattern: "isNewRecord=\\{isNewRecord\\}"
    - from: "src/components/LevelComplete.tsx"
      to: "src/utils/index.ts"
      via: "formatScore import for delta display"
      pattern: "formatScore\\(scoreDelta\\)"
---

<objective>
Add the "Nuovo Record!" badge to the LevelComplete screen. The badge appears only when the player genuinely beats their stored personal best (not on first play, not on a lower-score replay), and shows the exact score improvement in Italian-formatted points.

Purpose: Give players a clear, quantified reward signal when they improve — the primary motivator for replay in score-based puzzle games.
Output: GameScreen derives isNewRecord + scoreDelta before saving; LevelComplete renders gold badge with pulse animation when isNewRecord is true.
</objective>

<execution_context>
@/Users/martha2022/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martha2022/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-storage-and-score-utility/05-01-SUMMARY.md
@.planning/phases/05-storage-and-score-utility/05-02-SUMMARY.md
@.planning/phases/06-level-complete-record-badge/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add isNewRecord + scoreDelta logic to GameScreen</name>
  <files>src/components/GameScreen.tsx</files>
  <action>
Add two new useState declarations near the other state declarations at the top of the GameScreen component body:

```typescript
const [isNewRecord, setIsNewRecord] = useState(false);
const [scoreDelta, setScoreDelta] = useState<number | undefined>(undefined);
```

Also add the getLevelProgress import — it is already exported from '../game/storage' (Phase 5 established this). Add it to the existing import line:
```typescript
import { saveProgress, getLevelProgress } from '../game/storage';
```

Modify the completion useEffect (currently lines ~186-193). The read of getLevelProgress MUST happen before the saveProgress call. Set state before saving:

```typescript
useEffect(() => {
  if (state.status === 'completed') {
    const existing = getLevelProgress(state.level.id);
    const newRecord =
      existing?.bestScore !== undefined &&
      state.score > existing.bestScore;
    setIsNewRecord(newRecord);
    setScoreDelta(
      newRecord && existing?.bestScore !== undefined
        ? state.score - existing.bestScore
        : undefined
    );
    // score read from closure, not deps — intentional: fires once per completion only
    saveProgress(state.level.id, state.stars, timeElapsed, state.score);
  }
  // eslint-disable-next-line react-hooks/exhaustive-deps
}, [state.status, state.stars]);
```

CRITICAL: Do NOT add state.score to the dependency array. The intentional closure-capture pattern and existing lint suppression must be preserved exactly. The existing explanatory comment must remain.

CRITICAL guard: use `existing?.bestScore !== undefined && state.score > existing.bestScore` — NOT `state.score > (existing?.bestScore ?? 0)`. The ?? 0 form causes a false badge on every first play.

In handleRestart, add two reset calls after setTimeElapsed(0):
```typescript
setIsNewRecord(false);
setScoreDelta(undefined);
```

In handleNext, add the same two reset calls after setTimeElapsed(0):
```typescript
setIsNewRecord(false);
setScoreDelta(undefined);
```

In the LevelComplete JSX call site (currently around line 895-908), add the two new props:
```tsx
<LevelComplete
  levelNumber={...}
  stars={...}
  mistakes={...}
  hintsUsed={...}
  timeElapsed={timeElapsed}
  score={state.score}
  parTime={state.level.parTime}
  hasNextLevel={state.levelIndex + 1 < LEVELS.length}
  onNextLevel={onReturnToSelect}
  onReplay={handleRestart}
  isNewRecord={isNewRecord}
  scoreDelta={scoreDelta}
/>
```
  </action>
  <verify>
    <automated>cd /Users/martha2022/Documents/Sleevo && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Confirm getLevelProgress is imported, isNewRecord/scoreDelta useState declarations exist, completion useEffect reads getLevelProgress before saveProgress, both reset calls appear in handleRestart and handleNext, both new props appear on the LevelComplete JSX element.</manual>
  </verify>
  <done>TypeScript compiles with zero errors; getLevelProgress is called inside the completion useEffect before saveProgress; handleRestart and handleNext both call setIsNewRecord(false) and setScoreDelta(undefined); LevelComplete JSX receives isNewRecord and scoreDelta props.</done>
</task>

<task type="auto">
  <name>Task 2: Add badge UI and CSS animation to LevelComplete</name>
  <files>src/components/LevelComplete.tsx, src/components/LevelComplete.module.css</files>
  <action>
In LevelComplete.tsx:

1. Add formatScore import at the top of the file:
```typescript
import { formatScore } from '../utils';
```

2. Extend the Props interface with two optional fields:
```typescript
interface Props {
  levelNumber: number;
  stars: number;
  mistakes: number;
  hintsUsed: number;
  timeElapsed: number;
  score?: number;
  parTime?: number;
  hasNextLevel: boolean;
  onNextLevel: () => void;
  onReplay: () => void;
  isNewRecord?: boolean;   // NEW — true only on genuine improvement over prior bestScore
  scoreDelta?: number;     // NEW — undefined when isNewRecord is false
}
```

3. Destructure the two new props in the function signature:
```typescript
export function LevelComplete({
  levelNumber,
  stars,
  mistakes,
  hintsUsed,
  timeElapsed,
  score,
  parTime,
  hasNextLevel,
  onNextLevel,
  onReplay,
  isNewRecord,
  scoreDelta,
}: Props) {
```

4. Insert the badge JSX inside `.card`, AFTER the `.stars` block and BEFORE the `.stats` block:
```tsx
{isNewRecord && (
  <div className={styles.recordBadge}>
    <span className={styles.recordBadgeTitle}>Nuovo Record!</span>
    {scoreDelta !== undefined && (
      <span className={styles.recordBadgeDelta}>
        +{formatScore(scoreDelta)}
      </span>
    )}
  </div>
)}
```

The `+` is a literal string prefix; formatScore handles number formatting (e.g. formatScore(340) → "340 pt"). scoreDelta is always positive when isNewRecord is true (enforced by the strict `>` guard in GameScreen), so no sign-check is needed.

In LevelComplete.module.css, add the following CSS at the end of the file (after the confettiFall keyframe). Do not modify any existing CSS:

```css
.recordBadge {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  margin-bottom: 16px;
  animation: recordPulse 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.6s both;
}

.recordBadgeTitle {
  font-family: system-ui, sans-serif;
  font-size: 13px;
  font-weight: 700;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #ffd700;
  text-shadow: 0 0 12px rgba(255, 215, 0, 0.7), 0 0 24px rgba(255, 180, 0, 0.4);
}

.recordBadgeDelta {
  font-family: system-ui, sans-serif;
  font-size: 12px;
  font-weight: 600;
  color: rgba(255, 220, 100, 0.85);
  letter-spacing: 0.04em;
}

@keyframes recordPulse {
  0% {
    opacity: 0;
    transform: scale(0.7);
  }
  60% {
    opacity: 1;
    transform: scale(1.08);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}
```

Animation rationale: 0.6s delay sequences the badge after the third star's pop-in (which animates at 0.4s delay + 0.5s animation). Single entrance animation, NOT looping — a looping badge animation is confirmed as annoying. The badge stays visible as static styled text after the entrance.

Do NOT use animation-iteration-count: infinite. One pop, then static.
  </action>
  <verify>
    <automated>cd /Users/martha2022/Documents/Sleevo && npx tsc --noEmit 2>&1 | head -30</automated>
    <manual>Confirm Props interface has isNewRecord? and scoreDelta? fields; formatScore is imported from ../utils; recordBadge JSX appears between .stars and .stats; CSS file contains .recordBadge, .recordBadgeTitle, .recordBadgeDelta classes and @keyframes recordPulse.</manual>
  </verify>
  <done>TypeScript compiles with zero errors; LevelComplete.tsx has two new optional props destructured and used; badge JSX renders between stars and stats; CSS module contains all four new selectors with entrance-only animation.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verify badge behavior end-to-end</name>
  <action>No code changes — verify badge appears on genuine record, does not appear on first play or lower-score replay, resets between runs, and animation plays once.</action>
  <what-built>
    "Nuovo Record!" badge logic in GameScreen (isNewRecord + scoreDelta computation, prop passing, reset on restart/next) and badge UI in LevelComplete (conditional badge between stars and stats, gold pulse animation, formatted delta).
  </what-built>
  <how-to-verify>
    Run: npm run dev (or it may already be running on localhost:5173)

    Test 1 — First-play MUST NOT show badge:
    1. Open DevTools → Application → Local Storage → find the sleevo_progress key → delete it (or clear all storage)
    2. Reload page, navigate to any level, complete it
    3. Confirm: the LevelComplete card does NOT show "Nuovo Record!" or any delta text

    Test 2 — Genuine record MUST show badge with delta:
    4. Note the score from Test 1's completion (visible in the "Punti" stat)
    5. Click "Rigioca" (replay) — confirm badge is gone on the new run
    6. Complete the level scoring HIGHER than Test 1's score
    7. Confirm: "Nuovo Record!" badge appears in gold between the stars and the stats row
    8. Confirm: the delta text shows "+X pt" where X equals (new score - first score), formatted with Italian separator if >= 1000

    Test 3 — Lower-score replay MUST NOT show badge:
    9. Click "Rigioca", complete the level scoring LOWER than the current best
    10. Confirm: NO badge appears

    Test 4 — Badge resets across runs:
    11. Establish a new record (badge shows)
    12. Click "Rigioca"
    13. Confirm: the new run's LevelComplete screen shows no badge if score did not beat the record

    Test 5 — Animation check:
    14. On a genuine record run, observe the badge appears approximately 0.6s after the card is visible (after the stars animate in)
    15. Confirm: the badge pops in once and remains static (no looping pulse)
  </how-to-verify>
  <resume-signal>Type "approved" if all 5 tests pass, or describe which test failed and what was observed</resume-signal>
</task>

</tasks>

<verification>
TypeScript compiles with zero errors after both tasks.
Badge appears on genuine record, does not appear on first play or lower-score replay.
Badge does not persist into next run (reset confirmed in handleRestart and handleNext).
Delta formatted with Italian separator via formatScore (not inline formatting).
Animation is entrance-only, 0.6s delay, not looping.
</verification>

<success_criteria>
1. Completing a level with a score higher than the stored bestScore shows "Nuovo Record!" + "+X pt" delta in gold between stars and stats
2. Completing a level for the first time (no prior record in localStorage) shows NO badge
3. Replaying and scoring lower shows NO badge
4. Replaying immediately after a record run shows NO badge on the new completion screen
5. TypeScript reports zero errors
6. formatScore is the sole source of delta formatting — no inline Intl.NumberFormat
</success_criteria>

<output>
After completion, create `.planning/phases/06-level-complete-record-badge/06-01-SUMMARY.md` following the summary template.
</output>
