---
phase: 05-storage-and-score-utility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/game/storage.ts
  - src/utils/formatScore.ts
  - src/utils/index.ts
autonomous: true
requirements:
  - PERSIST-01
  - PERSIST-02

must_haves:
  truths:
    - "Completing a level saves its bestScore to localStorage"
    - "Replaying with a lower score does not overwrite the stored bestScore"
    - "Replaying with a higher score does overwrite the stored bestScore"
    - "Saving a score does not erase existing stars or bestTime from the same record"
    - "formatScore(1420) returns '1.420 pt' regardless of system locale"
    - "formatScore(undefined) returns '—'"
  artifacts:
    - path: "src/game/storage.ts"
      provides: "Extended LevelProgress interface and saveProgress function"
      contains: "bestScore?: number"
    - path: "src/utils/formatScore.ts"
      provides: "Shared score formatting utility"
      exports: ["formatScore"]
    - path: "src/utils/index.ts"
      provides: "Re-exports formatScore for consumers"
      contains: "export * from './formatScore'"
  key_links:
    - from: "src/game/storage.ts saveProgress"
      to: "localStorage sleevo_progress"
      via: "spread-merge write"
      pattern: "\\.\\.\\.(existing)"
    - from: "src/utils/index.ts"
      to: "src/utils/formatScore.ts"
      via: "re-export"
      pattern: "export \\* from './formatScore'"
---

<objective>
Extend the localStorage schema to persist best scores and create the shared score formatting utility that Phase 6 and Phase 7 will consume.

Purpose: Both downstream phases depend on `bestScore` existing in `LevelProgress` and a single `formatScore` source of truth. Building UI before the storage layer is extended produces integration bugs.
Output: Extended `storage.ts` with best-only score semantics; `src/utils/formatScore.ts` with hardcoded `it-IT` locale.
</objective>

<execution_context>
@/Users/martha2022/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martha2022/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-storage-and-score-utility/05-RESEARCH.md
@src/game/storage.ts
@src/utils/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend LevelProgress and rewrite saveProgress with merge-write and independent scoreImproved condition</name>
  <files>src/game/storage.ts</files>
  <action>
Make two atomic changes to `src/game/storage.ts`:

1. Add `bestScore?: number` to the `LevelProgress` interface (after `bestTime?`):
```typescript
export interface LevelProgress {
  stars: number;
  bestTime?: number;
  bestScore?: number;   // undefined means level was never scored
}
```

2. Replace `saveProgress` entirely with the following implementation — do NOT keep the old function and add to it; replace it whole:
```typescript
export function saveProgress(
  levelId: string,
  stars: number,
  timeSeconds?: number,
  score?: number
): void {
  try {
    const data = loadAllProgress();
    const existing = data[levelId];
    const starsImproved = !existing || stars > existing.stars;
    const timeImproved = !starsImproved &&
      stars === existing?.stars &&
      timeSeconds !== undefined &&
      (existing.bestTime === undefined || timeSeconds < existing.bestTime);
    const scoreImproved = score !== undefined &&
      (existing?.bestScore === undefined || score > existing.bestScore);

    if (starsImproved || timeImproved || scoreImproved) {
      data[levelId] = {
        ...existing,
        stars: starsImproved ? stars : (existing?.stars ?? stars),
        bestTime: starsImproved || timeImproved ? timeSeconds : existing?.bestTime,
        bestScore: scoreImproved ? score : existing?.bestScore,
      };
      localStorage.setItem(PROGRESS_KEY, JSON.stringify(data));
    }
  } catch {
    // localStorage might be unavailable
  }
}
```

Critical constraints:
- `scoreImproved` is an INDEPENDENT condition ORed at the same level as `starsImproved` and `timeImproved` — a score improvement must trigger a write even when stars and time do not change.
- The write uses spread-merge `{ ...existing, ... }` — never an object literal without the spread; this preserves any future fields added to the schema.
- Do NOT use `?? 0` anywhere in the score comparison — `existing?.bestScore === undefined` is the correct first-play guard.
- `JSON.stringify` silently drops `undefined` values; the spread ensures fields that are `undefined` in the current run (e.g. `bestTime` when `timeSeconds` is not passed) fall through to the existing stored value via `existing?.bestTime`.
  </action>
  <verify>
    <automated>cd /Users/martha2022/Documents/Sleevo && npx tsc --noEmit 2>&1</automated>
    <manual>Confirm `LevelProgress` now has `bestScore?: number` field. Confirm `saveProgress` signature is `(levelId, stars, timeSeconds?, score?)`. Confirm spread-merge pattern is present in the write.</manual>
    <sampling_rate>run after this task, before Task 2</sampling_rate>
  </verify>
  <done>TypeScript compiles with no errors. `LevelProgress` has three fields: `stars`, `bestTime?`, `bestScore?`. `saveProgress` accepts an optional fourth `score` param. The write uses `{ ...existing, ... }` spread. `scoreImproved` is a top-level condition ORed alongside `starsImproved` and `timeImproved`.</done>
</task>

<task type="auto">
  <name>Task 2: Create formatScore utility and re-export from utils index</name>
  <files>src/utils/formatScore.ts, src/utils/index.ts</files>
  <action>
Create `src/utils/formatScore.ts` as a new file with exactly this content:
```typescript
/**
 * Format an integer score for display using Italian thousand-separator notation.
 * Always uses 'it-IT' locale — never the browser default — so that 1420 renders
 * as "1.420 pt" regardless of system language.
 * Returns '—' (em dash) for undefined/null (level never completed).
 */
export function formatScore(score: number | undefined | null): string {
  if (score === undefined || score === null) return '\u2014';
  return new Intl.NumberFormat('it-IT').format(score) + ' pt';
}
```

Then add `export * from './formatScore';` to `src/utils/index.ts` as a new line (after the existing re-exports). The existing lines must be preserved exactly.

Do NOT use inline `toLocaleString()` — always go through `Intl.NumberFormat('it-IT')`. Do NOT use `'en-IT'` or omit the locale argument.
  </action>
  <verify>
    <automated>cd /Users/martha2022/Documents/Sleevo && npx tsc --noEmit 2>&1 &amp;&amp; node -e "const { Intl: I } = globalThis; const fn = (s) => s === undefined || s === null ? '\u2014' : new I.NumberFormat('it-IT').format(s) + ' pt'; console.assert(fn(1420) === '1.420 pt', 'format 1420'); console.assert(fn(undefined) === '\u2014', 'format undefined'); console.assert(fn(420) === '420 pt', 'format 420'); console.log('formatScore assertions passed')"</automated>
    <manual>Confirm `src/utils/formatScore.ts` exists. Confirm `src/utils/index.ts` now contains `export * from './formatScore'`. Open browser console on the running app and run: `import('/src/utils/index.ts').then(m => console.log(m.formatScore(1420)))` — must log `1.420 pt`.</manual>
    <sampling_rate>run after this task completes</sampling_rate>
  </verify>
  <done>TypeScript compiles with no errors. `formatScore` is exported from `src/utils/index.ts`. `formatScore(1420)` returns `'1.420 pt'`. `formatScore(undefined)` returns `'—'`. `formatScore(420)` returns `'420 pt'`.</done>
</task>

</tasks>

<verification>
Run `npx tsc --noEmit` from project root — zero errors required.

Check `src/game/storage.ts`: `LevelProgress` has `bestScore?: number`. `saveProgress` has four params with spread-merge write.

Check `src/utils/formatScore.ts` exists and exports `formatScore`. Check `src/utils/index.ts` re-exports it.
</verification>

<success_criteria>
1. TypeScript builds with zero errors after both tasks.
2. `LevelProgress` interface is backward-compatible — existing localStorage entries with only `{stars, bestTime}` load without errors.
3. `saveProgress` with a `score` argument only overwrites `bestScore` when the new score is strictly greater than the stored one; when called without `score`, existing `bestScore` is preserved via spread.
4. `formatScore(1420)` === `'1.420 pt'` (Italian dot separator, no comma).
5. `formatScore(undefined)` === `'—'` (em dash, not `'0 pt'` or empty string).
</success_criteria>

<output>
After completion, create `.planning/phases/05-storage-and-score-utility/05-01-SUMMARY.md`
</output>
