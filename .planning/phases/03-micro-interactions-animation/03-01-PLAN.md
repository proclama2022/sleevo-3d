---
phase: 03-micro-interactions-animation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/game/rules.ts
  - src/game/engine.ts
  - src/components/ComboPopup/ComboPopup.tsx
autonomous: true
requirements:
  - MOTION-05

must_haves:
  truths:
    - "User sees combo popup ONLY after 4+ consecutive correct placements"
    - "User sees point bonus (e.g., '+150') NOT streak count"
    - "User sees combo popup near placed slot NOT screen center"
    - "User combo streak reduces by 1 on wrong placement NOT full reset"
  artifacts:
    - path: "src/game/rules.ts"
      provides: "Updated COMBO_TIERS with 4+ threshold"
      exports: ["COMBO_TIERS"]
      min_lines: 1
    - path: "src/game/engine.ts"
      provides: "Forgiving combo reset logic (streak - 1)"
      exports: ["gameReducer"]
      min_lines: 10
    - path: "src/components/ComboPopup/ComboPopup.tsx"
      provides: "Refactored combo popup showing point bonus with positioning"
      exports: ["ComboPopup", "ComboPopupProps"]
      min_lines: 100
  key_links:
    - from: "src/components/GameScreen.tsx"
      to: "src/components/ComboPopup/ComboPopup.tsx"
      via: "props (pointsBonus, position)"
      pattern: "ComboPopup"
    - from: "src/components/GameScreen.tsx"
      to: "src/game/engine.ts"
      via: "state access"
      pattern: "state\\.combo\\.streak"
---

# Plan 03-01: Combo System Refactor

**Goal:** Implement user decisions for combo behavior — higher threshold, point bonus display, forgiving reset, and position near placed slot.

**User Decisions from 03-CONTEXT.md:**
- Trigger threshold: 4+ correct placements in a row (higher bar, combo feels earned)
- Display content: Points bonus only (shows "+50", "+100", not streak count)
- Popup position: Floating near slot (not screen center)
- Reset behavior: Reduce by 1 (forgiving — wrong reduces streak by 1 but doesn't fully reset)

**Requirements Satisfied:** MOTION-05 (Combo popup rewards consecutive correct placements)

---

<task type="auto">
  <name>Task 1: Update Combo Threshold to 4+ Streak</name>
  <files>src/game/rules.ts</files>
  <action>
Find the `COMBO_TIERS` constant (currently has threshold at 2). Update `minStreak` values to start at 4 instead of 2:
- Tier 1: `{ minStreak: 0, multiplier: 1.0, label: '' }`
- Tier 2: `{ minStreak: 4, multiplier: 1.5, label: 'NICE!' }` (was 2)
- Tier 3: `{ minStreak: 6, multiplier: 2.0, label: 'GREAT!' }` (was 4)
- Tier 4: `{ minStreak: 8, multiplier: 3.0, label: 'AMAZING!' }` (was 6)
- Tier 5: `{ minStreak: 10, multiplier: 5.0, label: 'LEGENDARY!' }` (was 8)

Per user decision from 03-CONTEXT.md: "Trigger threshold: 4+ correct placements in a row — higher bar, combo feels like a real achievement"
</action>
  <verify>Combo popup should NOT appear until 4th consecutive correct placement. Test by placing 3 correct vinyls → no combo popup. Place 4th correct vinyl → combo popup appears.</verify>
  <done>Combo popup appears only after 4th consecutive correct placement</done>
</task>

<task type="auto">
  <name>Task 2: Reduce Combo Streak by 1 on Wrong Placement</name>
  <files>src/game/engine.ts</files>
  <action>
Find the combo decay/reduce logic in `engine.ts`. Locate where `INVALID_DROP` or wrong placement resets combo. Replace full reset (`streak = 0`) with reduction (`streak = Math.max(0, streak - 1)`). Ensure multiplier updates based on new reduced streak using `getMultiplier(newStreak)` from COMBO_TIERS.

Pseudo-code:
```typescript
case 'INVALID_DROP':
  const newStreak = Math.max(0, state.combo.streak - 1);
  return {
    ...state,
    combo: {
      streak: newStreak,
      multiplier: getMultiplier(newStreak),
      lastUpdate: now
    }
  };
```

Per user decision from 03-CONTEXT.md: "Reset behavior: Reduce by 1 (forgiving) — wrong reduces streak by 1 but doesn't fully reset"
</action>
  <verify>Build 5x streak, then make wrong placement → streak becomes 4x (not 0). Make 2 wrong placements from 5x → streak becomes 3x. Only fully resets if streak was 1 and wrong placement happens.</verify>
  <done>Wrong placement reduces streak by 1, not full reset</done>
</task>

<task type="auto">
  <name>Task 3: Refactor ComboPopup to Show Point Bonus</name>
  <files>src/components/ComboPopup/ComboPopup.tsx</files>
  <action>
Update props interface: change `combo: number` to `pointsBonus: number`, add optional `x, y` coordinates for positioning.

Update component structure: remove `ComboText` ("COMBO" label) and `ComboNumber` (streak count), add `PointsDisplay` showing "+{pointsBonus}".

Calculate points based on streak: formula is `basePoints * multiplier`. Example: 100 base * 2.0 multiplier (4x streak) = "+200".

Create styled component:
```typescript
const PointsDisplay = styled.span`
  font-family: ${(props) => props.theme.typography.fontFamily.display};
  font-size: ${(props) => props.theme.typography.fontSize.display.lg};
  font-weight: bold;
  color: #4ade80;
  text-shadow: 0 4px 24px rgba(74, 222, 128, 0.5);
`;
```

Per user decision from 03-CONTEXT.md: "Display content: Points bonus only — shows point bonus like '+50', '+100' (not streak count)"
</action>
  <verify>Combo popup shows "+200" instead of "4x COMBO". Point values increase with higher streaks. No "COMBO" label or streak count visible.</verify>
  <done>Combo popup shows point bonus only, not streak count</done>
</task>

<task type="auto">
  <name>Task 4: Position ComboPopup Near Placed Slot</name>
  <files>src/components/ComboPopup/ComboPopup.tsx</files>
  <action>
Update props interface:
```typescript
export interface ComboPopupProps {
  pointsBonus: number;
  position?: { x: number; y: number }; // Slot coordinates
  onComplete?: () => void;
}
```

Update `PopupOverlay` to use absolute positioning with slot coordinates:
```typescript
const PopupOverlay = styled.div<{ $x?: number; $y?: number }>`
  position: fixed;
  top: ${(props) => props.$y ? `${props.$y}px` : '50%'};
  left: ${(props) => props.$x ? `${props.$x}px` : '50%'};
  transform: ${(props) =>
    props.$x && props.$y
      ? 'translate(-50%, -100%)' // Above slot
      : 'translate(-50%, -50%)' // Center fallback
  };
  z-index: 1000;
  pointer-events: none;
`;
```

Add `-30px` vertical offset to position above slot without covering it.

Per user decision from 03-CONTEXT.md: "Popup position: Floating near slot — appears near the placed vinyl, fades out after showing"
</action>
  <verify>Popup appears above the placed slot, not screen center. Popup doesn't overlap the slot content. Works correctly at screen edges (no overflow).</verify>
  <done>Combo popup positioned near placed slot, not screen center</done>
</task>

<task type="auto">
  <name>Task 5: Wire ComboPopup in GameScreen with Slot Coordinates</name>
  <files>src/components/GameScreen.tsx</files>
  <action>
Add state tracking for last placed slot position:
```typescript
const [lastSlotPosition, setLastSlotPosition] = useState<{x: number, y: number} | null>(null);
```

Capture slot coordinates on placement using `getBoundingClientRect()` on slot element. Store center X, top Y coordinates. Update state when vinyl is correctly placed.

Pass coordinates to ComboPopup:
```typescript
{combo >= 4 && lastSlotPosition && (
  <ComboPopup
    pointsBonus={calculatePointsBonus(combo)}
    position={lastSlotPosition}
    onComplete={() => setLastSlotPosition(null)}
  />
)}
```

Per user decision from 03-CONTEXT.md: "Popup position: Floating near slot"
</action>
  <verify>Place vinyl at top-left slot → popup appears above that slot. Place vinyl at bottom-right slot → popup appears above that slot. Popup coordinates update correctly for each placement.</verify>
  <done>Slot coordinates captured and passed to ComboPopup for positioning</done>
</task>

---

## Success Criteria

- [ ] Combo threshold requires 4+ consecutive correct placements
- [ ] Wrong placement reduces streak by 1 (not full reset)
- [ ] Combo popup shows point bonus ("+150", not "4x COMBO")
- [ ] Combo popup appears near placed slot, not screen center
- [ ] Works correctly at all screen positions without overflow

---

## Testing Checklist

- [ ] Place 3 correct vinyls → verify no combo popup appears
- [ ] Place 4th correct vinyl → verify combo popup shows "+{points}"
- [ ] Build 5x streak, make wrong placement → verify streak becomes 4x
- [ ] Verify popup positioning at all 4 corners of screen
- [ ] Verify popup auto-dismisses after animation completes
- [ ] Test with reduced motion enabled → verify instant appear/fade

---

## Files Modified

- `src/game/rules.ts` - Update COMBO_TIERS threshold (2 → 4)
- `src/game/engine.ts` - Implement forgiving reset (streak - 1)
- `src/components/ComboPopup/ComboPopup.tsx` - Show points bonus, position near slot
- `src/components/GameScreen.tsx` - Pass slot coordinates to ComboPopup

---

## Dependencies

**Depends on:** None (can start immediately)

**Blocks:** None (independent refactor, but 03-02 uses same positioning logic)

## Phase

**Phase:** 03-micro-interactions-animation
**Plan:** 01
**Type:** execute
