---
phase: 01-campaign-structure-star-system-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/starCalculation.ts
  - constants/starThresholds.ts
  - services/storage.ts
  - types.ts
autonomous: true

must_haves:
  truths:
    - "Star rating calculated correctly: 1 star for completion, 2 stars for good accuracy, 3 stars for perfect + combo"
    - "Mode-specific star criteria exist for Standard, Timed, SuddenDeath, Boss modes"
    - "SaveData persists best star rating per level across sessions"
    - "Existing save data migrates without data loss when new fields added"
  artifacts:
    - path: "services/starCalculation.ts"
      provides: "Star calculation logic with mode-specific criteria"
      exports: ["StarCriteria", "getStarCriteria", "calculateStarsEarned", "calculateCurrentStars"]
    - path: "constants/starThresholds.ts"
      provides: "Tunable star threshold constants"
      contains: "STAR_THRESHOLDS"
    - path: "services/storage.ts"
      provides: "Extended SaveData with totalStars and campaign progress tracking"
      contains: "totalStars"
    - path: "types.ts"
      provides: "Extended type definitions for star system"
      contains: "CampaignLevel"
  key_links:
    - from: "services/starCalculation.ts"
      to: "constants/starThresholds.ts"
      via: "import thresholds"
      pattern: "import.*starThresholds"
    - from: "services/starCalculation.ts"
      to: "types.ts"
      via: "import GameState, LevelMode"
      pattern: "import.*GameState.*LevelMode"
    - from: "services/storage.ts"
      to: "services/starCalculation.ts"
      via: "star rating stored from calculation"
      pattern: "stars.*number"
---

<objective>
Create the star calculation service and extend the storage layer to support the 3-star rating system.

Purpose: This is the foundational data layer that all star UI components and level configs will depend on. Without reliable star calculation and persistence, no other Phase 1 feature works.

Output: `services/starCalculation.ts`, `constants/starThresholds.ts`, extended `services/storage.ts` and `types.ts`
</objective>

<execution_context>
@/Users/martha2022/.claude/get-shit-done/workflows/execute-plan.md
@/Users/martha2022/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-campaign-structure-star-system-foundation/01-RESEARCH.md

@types.ts
@services/storage.ts
@services/gameLogic.ts
@constants/gameConfig.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create star threshold constants and calculation service</name>
  <files>constants/starThresholds.ts, services/starCalculation.ts, types.ts</files>
  <action>
1. Create `constants/starThresholds.ts` with tunable threshold constants:
   - `STAR_THRESHOLDS` object with per-mode defaults:
     - Standard: 2-star = 80% accuracy, 3-star = 100% accuracy + 3x combo minimum
     - Timed: 2-star = 75% accuracy + 25% time remaining, 3-star = 85% accuracy + 50% time remaining
     - SuddenDeath: 2-star = complete (1 mistake allowed), 3-star = zero mistakes
     - Boss: 2-star = 70% accuracy, 3-star = 90% accuracy + complete in 60% of max time
   - Export `DEFAULT_TWO_STAR_ACCURACY`, `DEFAULT_THREE_STAR_ACCURACY`, `DEFAULT_THREE_STAR_MIN_COMBO` as separate constants for easy tuning

2. Create `services/starCalculation.ts` with pure functions (no React dependencies):
   - `StarCriteria` interface: `{ twoStar: { accuracyThreshold: number; timeThreshold?: number; description: string }; threeStar: { accuracyThreshold: number; minCombo?: number; maxTimeRatio?: number; description: string } }`
   - `getStarCriteria(levelNumber: number, mode: LevelMode): StarCriteria` — Returns criteria based on mode, using thresholds from `starThresholds.ts`. levelNumber param allows per-level override in future.
   - `calculateStarsEarned(gameState: GameState, criteria: StarCriteria): number` — Final calculation at level completion. Returns 0 if not won, 1 for completion, 2/3 based on criteria. Calculate accuracy as `(totalMoves - mistakes) / totalMoves`. Handle edge case where totalMoves is 0 (return 1 star if won).
   - `calculateCurrentStars(gameState: GameState, criteria: StarCriteria): number` — Real-time calculation during gameplay. Same logic as calculateStarsEarned but works during 'playing' status (assumes player will complete for projection purposes).

3. Extend `types.ts`:
   - Add `CampaignLevel` interface: `{ levelNumber: number; worldNumber: number; handCrafted: boolean; config: LevelConfig }` (for future level config use)
   - Add `LevelConfig` interface: `{ crates: number; genres: Genre[]; mode: LevelMode; theme: ShopTheme; time: number; moves: number; starCriteria?: StarCriteria }` — Optional starCriteria for hand-crafted override
   - Do NOT modify existing interfaces (GameState already has starsEarned, LevelMode already exists)
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Manually verify:
- `starCalculation.ts` exports all 4 symbols (StarCriteria, getStarCriteria, calculateStarsEarned, calculateCurrentStars)
- `starThresholds.ts` exports STAR_THRESHOLDS
- types.ts has CampaignLevel and LevelConfig interfaces
  </verify>
  <done>Star calculation service exists with mode-specific criteria for Standard/Timed/SuddenDeath/Boss modes. Thresholds are tunable via constants file. All types compile without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Extend SaveData for campaign star tracking</name>
  <files>services/storage.ts</files>
  <action>
1. Add `totalStars` computed field to SaveData interface:
   - Add `totalStars: number` field (denormalized for quick access, computed from levelStars)
   - Add `highestLevelUnlocked: number` field (tracks furthest level reached, starts at 1)
   - Note: `levelStars` and `levelRecords` already exist in SaveData — do NOT duplicate

2. Update `getDefaultSaveData()`:
   - Add `totalStars: 0`
   - Add `highestLevelUnlocked: 1`

3. Update migration in `loadSaveData()`:
   - Add `totalStars: parsed.data.totalStars ?? 0`
   - Add `highestLevelUnlocked: parsed.data.highestLevelUnlocked ?? (parsed.data.level || 1)`
   - Existing levelStars migration already handles `parsed.data.levelStars ?? {}`

4. Create helper function `updateStarProgress`:
   ```typescript
   export const updateStarProgress = (
     currentSave: SaveData,
     levelIndex: number,
     starsEarned: number
   ): SaveData => {
     const previousStars = currentSave.levelStars[levelIndex] || 0;
     const newStars = Math.max(previousStars, starsEarned);

     // Only update if improvement
     if (newStars <= previousStars) return currentSave;

     const updatedLevelStars = { ...currentSave.levelStars, [levelIndex]: newStars };
     const totalStars = Object.values(updatedLevelStars).reduce((sum, s) => sum + s, 0);

     // Unlock next level if this is current highest
     const highestLevelUnlocked = Math.max(
       currentSave.highestLevelUnlocked,
       levelIndex + 2 // levelIndex is 0-based, unlock next level
     );

     return { ...currentSave, levelStars: updatedLevelStars, totalStars, highestLevelUnlocked };
   };
   ```

5. Ensure `updateLevelRecords` (already exists) continues to work — do NOT modify it, the new `updateStarProgress` is a separate concern that handles star-specific logic.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Check that:
- `loadSaveData()` returns object with `totalStars` and `highestLevelUnlocked` fields
- `updateStarProgress` correctly tracks best stars per level
- Existing `updateLevelRecords` still compiles and works unchanged
  </verify>
  <done>SaveData extended with totalStars and highestLevelUnlocked. Migration handles existing saves without data loss. New updateStarProgress function tracks best star rating per level and computes totalStars.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `services/starCalculation.ts` has pure functions with no React imports
- `constants/starThresholds.ts` has all threshold constants
- `services/storage.ts` has `updateStarProgress` function
- Existing save data (if any in localStorage) would migrate cleanly with new defaults
</verification>

<success_criteria>
- Star calculation returns correct values: 0 for loss, 1 for completion, 2 for good accuracy, 3 for perfect + combo
- Mode-specific criteria differ for Standard vs Timed vs Boss
- SaveData tracks totalStars and highestLevelUnlocked
- All existing code still compiles (no breaking changes to GameState, SaveData, etc.)
</success_criteria>

<output>
After completion, create `.planning/phases/01-campaign-structure-star-system-foundation/01-01-SUMMARY.md`
</output>
